name: CI

on:
  push:
    branches: [ "auto_chat_template" ]
  pull_request:
    branches: [ "auto_chat_template" ]
  workflow_dispatch:

# 需要写 release / tag 的权限
permissions:
  contents: write

jobs:
  build-x86:
    name: x86 Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare 3rdparty
        run: git submodule update --init

      - name: Build x86
        run: sh ./build.sh

      - name: Upload x86 artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-x86
          path: build/install/

  build-aarch64:
    name: aarch64 Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare 3rdparty
        run: git submodule update --init

      - name: Build aarch64
        run: sh ./build_aarch64.sh

      - name: Upload aarch64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-aarch64
          path: build_aarch64/install/

  build-windows-mingw64:
    name: Windows MinGW64 Build
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare 3rdparty
        run: git submodule update --init

      - name: Setup MSYS2 (MINGW64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            unzip
            curl

      - name: Build Windows (mingw64)
        shell: msys2 {0}
        run: bash ./build_mingw64.sh

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-windows-mingw64
          path: build_mingw64/install/

  release:
    name: Publish SDKs to fixed Release tag
    runs-on: ubuntu-latest
    needs: [build-x86, build-aarch64, build-windows-mingw64]
    steps:
      - uses: actions/checkout@v4

      # 下载三个构建产物
      - name: Download x86 artifact
        uses: actions/download-artifact@v4
        with:
          name: build-x86
          path: dist/build-x86

      - name: Download aarch64 artifact
        uses: actions/download-artifact@v4
        with:
          name: build-aarch64
          path: dist/build-aarch64

      - name: Download windows mingw64 artifact
        uses: actions/download-artifact@v4
        with:
          name: build-windows-mingw64
          path: dist/build-windows-mingw64

      # 打包：你也可以按自己的命名习惯改文件名
      - name: Pack SDK archives
        run: |
          set -euo pipefail
          mkdir -p out

          tar -C dist/build-x86 -czf out/hf-auto-sdk-linux-x86_64.tar.gz .
          tar -C dist/build-aarch64 -czf out/hf-auto-sdk-linux-aarch64.tar.gz .
          (cd dist/build-windows-mingw64 && zip -r ../../out/hf-auto-sdk-windows-mingw64.zip .)

          ls -lah out

      # 生成 sha256（包含每个包的 sha）
      - name: Generate per-file sha256
        run: |
          set -euo pipefail
          cd out

          # 给每个压缩包生成一个对应的 .sha256 文件
          for f in *.tar.gz *.zip; do
            [ -f "$f" ] || continue
            sha256sum "$f" > "${f}.sha256"
          done

          ls -lah
          echo "---- sha files ----"
          for s in *.sha256; do
            echo "== $s =="
            cat "$s"
          done

      # 使用固定 tag：sdk-latest
      # - 若 release 不存在：创建
      # - 若已存在：覆盖上传（--clobber），并把 tag 强制指向当前 commit
      - name: Create/Update fixed Release (sdk-latest)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: sdk-latest
        run: |
          set -euo pipefail

          git fetch --tags

          # 强制把 tag 移动到当前提交，确保“固定tag永远指向最新main”
          git tag -f "$TAG" "$GITHUB_SHA"
          git push origin -f "refs/tags/$TAG"

          # 若 release 不存在就创建（存在则跳过）
          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" \
              --title "SDK Latest" \
              --notes "Auto-published from main: $GITHUB_SHA"
          else
            # 可选：更新说明
            gh release edit "$TAG" --notes "Auto-updated from main: $GITHUB_SHA"
          fi

          # 上传/覆盖 assets
          gh release upload "$TAG" out/* --clobber
